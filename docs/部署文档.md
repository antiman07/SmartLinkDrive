# SmartLinkDrive 部署文档

## 一、部署概述

本文档描述SmartLinkDrive平台在**单机开发环境**下的部署流程。所有服务（基础设施和微服务）都部署在同一台物理机上。

### 1.1 部署架构

```
单机部署架构:
┌─────────────────────────────────────────┐
│           物理机/虚拟机                   │
│  ┌──────────────────────────────────┐   │
│  │     Docker容器（基础设施）        │   │
│  │  - MySQL                         │   │
│  │  - Redis                         │   │
│  │  - ClickHouse                    │   │
│  │  - Consul                        │   │
│  │  - Kafka                         │   │
│  │  - Jaeger                        │   │
│  │  - Prometheus                    │   │
│  │  - Grafana                       │   │
│  │  - ELK Stack                     │   │
│  └──────────────────────────────────┘   │
│  ┌──────────────────────────────────┐   │
│  │     Go微服务（本地运行）          │   │
│  │  - user-service                  │   │
│  │  - vehicle-service               │   │
│  │  - order-service                 │   │
│  │  - ...                           │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### 1.2 系统要求

**最低配置:**
- CPU: 4核
- 内存: 8GB
- 磁盘: 50GB SSD
- 操作系统: Linux/macOS/Windows

**推荐配置:**
- CPU: 8核+
- 内存: 16GB+
- 磁盘: 100GB+ SSD
- 操作系统: Linux (Ubuntu 20.04+)

---

## 二、部署前准备

### 2.1 检查系统环境

```bash
# 检查Docker版本
docker --version
docker-compose --version

# 检查Go版本
go version

# 检查磁盘空间
df -h

# 检查内存
free -h
```

### 2.2 创建目录结构

```bash
# 创建项目目录
mkdir -p /opt/smartlinkdrive/{logs,data,configs}

# 创建数据目录
mkdir -p /opt/smartlinkdrive/data/{mysql,redis,clickhouse,prometheus,grafana,elasticsearch}

# 设置权限
chmod -R 755 /opt/smartlinkdrive
```

### 2.3 配置防火墙（可选）

```bash
# 开放必要端口
# MySQL: 3306
# Redis: 6379
# ClickHouse: 8123, 9000
# Consul: 8500
# Kafka: 9092
# Jaeger: 16686, 14268
# Prometheus: 9090
# Grafana: 3000
# Elasticsearch: 9200
# Kibana: 5601
```

---

## 三、部署基础设施服务

### 3.1 使用Docker Compose部署

**步骤1: 进入项目目录**
```bash
cd /path/to/SmartLinkDrive
cd deployments
```

**步骤2: 检查配置文件**
```bash
# 检查docker-compose.yml
cat docker-compose.yml

# 检查配置文件
ls -la configs/
```

**步骤3: 启动所有服务**
```bash
# 后台启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

**步骤4: 验证服务运行**

```bash
# 检查所有容器状态
docker-compose ps

# 应该看到所有服务都是 "Up" 状态
```

### 3.2 单独启动服务

如果需要单独启动某个服务:

```bash
# 启动MySQL
docker-compose up -d mysql

# 启动Redis
docker-compose up -d redis

# 启动Kafka（需要先启动Zookeeper）
docker-compose up -d zookeeper
docker-compose up -d kafka
```

### 3.3 服务健康检查

**MySQL:**
```bash
docker exec -it smartlinkdrive-mysql mysql -uroot -proot -e "SELECT 1"
```

**Redis:**
```bash
docker exec -it smartlinkdrive-redis redis-cli ping
# 应该返回: PONG
```

**Consul:**
```bash
curl http://localhost:8500/v1/status/leader
```

**Kafka:**
```bash
docker exec -it smartlinkdrive-kafka kafka-topics --list --bootstrap-server localhost:9092
```

**ClickHouse:**
```bash
docker exec -it smartlinkdrive-clickhouse clickhouse-client --query "SELECT 1"
```

**Jaeger:**
```bash
curl http://localhost:16686
```

**Prometheus:**
```bash
curl http://localhost:9090/-/healthy
```

**Elasticsearch:**
```bash
curl http://localhost:9200
```

---

## 四、配置数据库

### 4.1 MySQL初始化

**步骤1: 连接到MySQL**
```bash
docker exec -it smartlinkdrive-mysql mysql -uroot -proot
```

**步骤2: 创建数据库和用户**
```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS smartlinkdrive CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建应用用户
CREATE USER IF NOT EXISTS 'app'@'%' IDENTIFIED BY 'app123';
GRANT ALL PRIVILEGES ON smartlinkdrive.* TO 'app'@'%';
FLUSH PRIVILEGES;

-- 使用数据库
USE smartlinkdrive;

-- 创建用户表（示例）
CREATE TABLE IF NOT EXISTS users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建车辆表（示例）
CREATE TABLE IF NOT EXISTS vehicles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    vehicle_no VARCHAR(20) UNIQUE NOT NULL COMMENT '车牌号',
    vin VARCHAR(50) UNIQUE COMMENT 'VIN码',
    brand VARCHAR(50) COMMENT '品牌',
    model VARCHAR(50) COMMENT '型号',
    status TINYINT DEFAULT 0 COMMENT '状态: 0-离线, 1-在线, 2-服务中',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_vehicle_no (vehicle_no),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 4.2 ClickHouse初始化

**步骤1: 连接到ClickHouse**
```bash
docker exec -it smartlinkdrive-clickhouse clickhouse-client
```

**步骤2: 创建数据库和表**
```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS smartlinkdrive;

-- 使用数据库
USE smartlinkdrive;

-- 创建车辆轨迹表
CREATE TABLE IF NOT EXISTS vehicle_trajectory (
    vehicle_id String,
    timestamp DateTime,
    latitude Float64,
    longitude Float64,
    speed Float32,
    direction Float32,
    altitude Float32,
    mileage Float64
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (vehicle_id, timestamp)
TTL timestamp + INTERVAL 90 DAY;  -- 90天后自动删除

-- 创建传感器数据表
CREATE TABLE IF NOT EXISTS sensor_data (
    device_id String,
    timestamp DateTime,
    temperature Float32,
    humidity Float32,
    vibration Float32,
    fuel_level Float32
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (device_id, timestamp)
TTL timestamp + INTERVAL 180 DAY;
```

### 4.3 Redis配置验证

```bash
# 连接Redis
docker exec -it smartlinkdrive-redis redis-cli

# 测试写入和读取
SET test "hello"
GET test
```

---

## 五、部署微服务

### 5.1 构建服务

**方式1: 使用Make构建**
```bash
cd /path/to/SmartLinkDrive
make build
```

**方式2: 手动构建**
```bash
# 构建用户服务
go build -o bin/user-service ./cmd/user-service

# 构建车辆服务
go build -o bin/vehicle-service ./cmd/vehicle-service
```

### 5.2 配置服务

**检查配置文件:**
```bash
cat deployments/configs/user-service.json
cat deployments/configs/vehicle-service.json
```

**根据实际情况修改配置:**
- 数据库连接信息
- Redis连接信息
- Consul地址
- 服务端口等

### 5.3 启动服务

**方式1: 直接运行**
```bash
# 启动用户服务
./bin/user-service -config deployments/configs/user-service.json

# 启动车辆服务（新终端）
./bin/vehicle-service -config deployments/configs/vehicle-service.json
```

**方式2: 使用systemd（Linux）**

创建systemd服务文件 `/etc/systemd/system/user-service.service`:
```ini
[Unit]
Description=SmartLinkDrive User Service
After=network.target

[Service]
Type=simple
User=smartlinkdrive
WorkingDirectory=/opt/smartlinkdrive
ExecStart=/opt/smartlinkdrive/bin/user-service -config /opt/smartlinkdrive/configs/user-service.json
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

启动服务:
```bash
sudo systemctl daemon-reload
sudo systemctl enable user-service
sudo systemctl start user-service
sudo systemctl status user-service
```

### 5.4 使用Supervisor管理（可选）

安装Supervisor:
```bash
sudo apt-get install supervisor  # Ubuntu/Debian
sudo yum install supervisor      # CentOS/RHEL
```

创建配置文件 `/etc/supervisor/conf.d/user-service.conf`:
```ini
[program:user-service]
command=/opt/smartlinkdrive/bin/user-service -config /opt/smartlinkdrive/configs/user-service.json
directory=/opt/smartlinkdrive
user=smartlinkdrive
autostart=true
autorestart=true
stderr_logfile=/opt/smartlinkdrive/logs/user-service.err.log
stdout_logfile=/opt/smartlinkdrive/logs/user-service.out.log
```

启动:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start user-service
```

---

## 六、验证部署

### 6.1 验证服务注册

**访问Consul UI:**
- 打开浏览器: http://localhost:8500/ui/dc1/services
- 应该看到所有微服务已注册

**使用API验证:**
```bash
# 获取所有服务
curl http://localhost:8500/v1/agent/services

# 获取用户服务健康状态
curl http://localhost:8500/v1/health/service/user-service
```

### 6.2 验证gRPC服务

```bash
# 使用grpcurl测试
grpcurl -plaintext localhost:50051 list

# 健康检查
grpcurl -plaintext -d '{"service":"user-service"}' \
    localhost:50051 grpc.health.v1.Health/Check
```

### 6.3 验证监控

**Prometheus:**
- 访问: http://localhost:9090
- 检查targets: Status -> Targets
- 应该看到所有服务都是 "UP" 状态

**Grafana:**
- 访问: http://localhost:3000
- 默认账号: admin/admin
- 配置Prometheus数据源
- 导入Dashboard

**Jaeger:**
- 访问: http://localhost:16686
- 查看trace信息

---

## 七、服务管理

### 7.1 Docker服务管理

```bash
# 停止所有服务
docker-compose stop

# 启动所有服务
docker-compose start

# 重启服务
docker-compose restart [service-name]

# 停止并删除容器
docker-compose down

# 停止并删除容器和数据卷（危险！）
docker-compose down -v

# 查看日志
docker-compose logs -f [service-name]

# 查看资源使用
docker stats
```

### 7.2 数据备份

**MySQL备份:**
```bash
# 备份数据库
docker exec smartlinkdrive-mysql mysqldump -uroot -proot smartlinkdrive > backup_$(date +%Y%m%d).sql

# 恢复数据库
docker exec -i smartlinkdrive-mysql mysql -uroot -proot smartlinkdrive < backup_20240101.sql
```

**Redis备份:**
```bash
# 创建快照
docker exec smartlinkdrive-redis redis-cli BGSAVE

# 导出数据
docker exec smartlinkdrive-redis redis-cli --rdb /data/dump.rdb
docker cp smartlinkdrive-redis:/data/dump.rdb ./backup/
```

**ClickHouse备份:**
```bash
# 导出数据
docker exec smartlinkdrive-clickhouse clickhouse-client \
    --query "SELECT * FROM vehicle_trajectory FORMAT CSV" > backup_trajectory.csv
```

---

## 八、故障排查

### 8.1 查看日志

**Docker服务日志:**
```bash
# 查看所有日志
docker-compose logs

# 查看特定服务日志
docker-compose logs mysql
docker-compose logs -f mysql  # 实时日志

# 查看最近100行
docker-compose logs --tail=100 mysql
```

**微服务日志:**
```bash
tail -f logs/user-service.log
tail -f logs/vehicle-service.log
```

### 8.2 常见问题

**问题1: 端口冲突**
```bash
# 检查端口占用
netstat -tlnp | grep :3306  # Linux
lsof -i :3306                # macOS

# 修改docker-compose.yml中的端口映射
```

**问题2: 容器无法启动**
```bash
# 查看容器状态
docker ps -a

# 查看详细错误
docker logs smartlinkdrive-mysql

# 检查资源使用
docker stats
```

**问题3: 服务无法连接数据库**
```bash
# 检查数据库是否运行
docker ps | grep mysql

# 测试数据库连接
docker exec -it smartlinkdrive-mysql mysql -uroot -proot -e "SELECT 1"

# 检查网络连接
docker network inspect smartlinkdrive_smartlinkdrive-network
```

**问题4: 内存不足**
```bash
# 检查内存使用
free -h
docker stats

# 限制容器内存（在docker-compose.yml中）
services:
  mysql:
    deploy:
      resources:
        limits:
          memory: 1G
```

---

## 九、性能优化

### 9.1 Docker资源限制

在 `docker-compose.yml` 中设置资源限制:

```yaml
services:
  mysql:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 1G
```

### 9.2 数据库优化

**MySQL优化:**
- 调整 `innodb_buffer_pool_size`
- 启用慢查询日志
- 创建合适的索引

**Redis优化:**
- 设置合理的 `maxmemory` 和 `maxmemory-policy`
- 使用Pipeline批量操作

### 9.3 日志轮转

配置日志轮转防止磁盘满:

```bash
# 创建logrotate配置
cat > /etc/logrotate.d/smartlinkdrive << EOF
/opt/smartlinkdrive/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}
EOF
```

---

## 十、安全建议

### 10.1 修改默认密码

**修改MySQL root密码:**
```sql
ALTER USER 'root'@'%' IDENTIFIED BY 'new_strong_password';
```

**修改Redis密码:**
在 `redis.conf` 中设置:
```
requirepass your_strong_password
```

### 10.2 网络隔离

使用Docker网络隔离服务:
```yaml
networks:
  smartlinkdrive-network:
    driver: bridge
    internal: false  # 根据需求设置
```

### 10.3 防火墙配置

只开放必要端口:
```bash
# 仅允许本地访问
iptables -A INPUT -p tcp --dport 3306 -s 127.0.0.1 -j ACCEPT
iptables -A INPUT -p tcp --dport 3306 -j DROP
```

---

## 十一、维护计划

### 11.1 定期维护任务

- **每日**: 检查服务状态、查看错误日志
- **每周**: 检查磁盘空间、数据库备份
- **每月**: 更新依赖、性能分析、安全审计

### 11.2 监控告警

配置Prometheus AlertManager告警规则:
- 服务不可用
- 数据库连接失败
- 磁盘空间不足
- 内存使用过高

---

## 十二、升级流程

### 12.1 微服务升级

```bash
# 1. 备份当前版本
cp -r bin bin_backup_$(date +%Y%m%d)

# 2. 构建新版本
make build

# 3. 灰度发布（先启动新实例）
./bin/user-service -config configs/user-service.json

# 4. 验证新版本
# ... 测试 ...

# 5. 停止旧版本
# 使用systemd/supervisor管理
```

### 12.2 Docker服务升级

```bash
# 1. 拉取新镜像
docker-compose pull

# 2. 停止旧服务
docker-compose stop [service-name]

# 3. 启动新服务
docker-compose up -d [service-name]

# 4. 验证
docker-compose ps
docker-compose logs -f [service-name]
```

---

*文档版本: v1.0*  
*最后更新: 2024年*
