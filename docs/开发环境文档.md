# SmartLinkDrive 开发环境文档

## 一、环境要求

### 1.1 必需软件

- **操作系统**: Windows 10/11, macOS, Linux
- **Go**: 1.21 或更高版本
- **Docker**: 20.10 或更高版本
- **Docker Compose**: 2.0 或更高版本
- **Make**: 可选，用于执行构建脚本
- **Protocol Buffers**: 用于生成gRPC代码

### 1.2 推荐工具

- **IDE**: VS Code 或 GoLand
- **API测试工具**: Postman, grpcurl, BloomRPC
- **数据库管理工具**: DBeaver, MySQL Workbench, DataGrip

---

## 二、开发环境搭建步骤

### 2.1 安装Go

**Windows:**
```powershell
# 下载安装包: https://golang.org/dl/
# 安装后设置环境变量
$env:GOPATH = "F:\code\golang"
$env:PATH = "$env:PATH;C:\Program Files\Go\bin"
```

**macOS:**
```bash
brew install go
```

**Linux:**
```bash
wget https://go.dev/dl/go1.21.5.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin
```

验证安装:
```bash
go version
```

### 2.2 安装Docker和Docker Compose

**Windows/macOS:**
- 下载并安装 Docker Desktop: https://www.docker.com/products/docker-desktop
- Docker Compose已包含在Docker Desktop中

**Linux:**
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

验证安装:
```bash
docker --version
docker-compose --version
```

### 2.3 安装Protocol Buffers编译器

**Windows:**
```powershell
# 下载: https://github.com/protocolbuffers/protobuf/releases
# 解压后将bin目录添加到PATH
```

**macOS:**
```bash
brew install protobuf
```

**Linux:**
```bash
sudo apt-get install protobuf-compiler
```

验证安装:
```bash
protoc --version
```

### 2.4 安装Go插件

```bash
# 安装Protobuf Go插件
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@latest

# 确保GOPATH/bin在PATH中
export PATH=$PATH:$(go env GOPATH)/bin
```

---

## 三、项目初始化

### 3.1 克隆项目

```bash
cd F:\code\golang\src\github.com\SmartLinkDrive
```

### 3.2 安装项目依赖

```bash
go mod download
go mod tidy
```

### 3.3 生成Protobuf代码

```bash
make proto
# 或者手动执行:
protoc --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    internal/api/proto/**/*.proto
```

---

## 四、启动基础设施服务

### 4.1 启动Docker服务

所有基础设施服务（MySQL、Redis、ClickHouse、Consul、Kafka、Jaeger等）都通过Docker Compose在同一台物理机上运行。

```bash
# 进入deployments目录
cd deployments

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f [service-name]
```

### 4.2 验证服务运行状态

**MySQL:**
```bash
docker exec -it smartlinkdrive-mysql mysql -uroot -proot
```

**Redis:**
```bash
docker exec -it smartlinkdrive-redis redis-cli
```

**Consul UI:**
- 浏览器打开: http://localhost:8500

**Jaeger UI:**
- 浏览器打开: http://localhost:16686

**Prometheus:**
- 浏览器打开: http://localhost:9090

**Grafana:**
- 浏览器打开: http://localhost:3000
- 默认账号: admin/admin

**Kibana:**
- 浏览器打开: http://localhost:5601

**ClickHouse:**
```bash
docker exec -it smartlinkdrive-clickhouse clickhouse-client
```

---

## 五、运行微服务

### 5.1 运行用户服务

```bash
# 方式1: 使用Make
make run-user

# 方式2: 直接运行
go run cmd/user-service/main.go -config deployments/configs/user-service.json

# 方式3: 构建后运行
make build
./bin/user-service -config deployments/configs/user-service.json
```

### 5.2 运行车辆服务

```bash
# 方式1: 使用Make
make run-vehicle

# 方式2: 直接运行
go run cmd/vehicle-service/main.go -config deployments/configs/vehicle-service.json

# 方式3: 构建后运行
./bin/vehicle-service -config deployments/configs/vehicle-service.json
```

### 5.3 验证服务运行

**检查gRPC服务:**
```bash
# 使用grpcurl测试
grpcurl -plaintext localhost:50051 list

# 健康检查
grpcurl -plaintext localhost:50051 grpc.health.v1.Health/Check
```

**检查Consul服务注册:**
- 浏览器打开: http://localhost:8500/ui/dc1/services
- 应该能看到 `user-service` 和 `vehicle-service`

---

## 六、开发工具配置

### 6.1 VS Code配置

安装推荐插件:
- Go (golang.go)
- Protocol Buffers (zxh404.vscode-proto3)

创建 `.vscode/settings.json`:
```json
{
  "go.formatTool": "goimports",
  "go.lintTool": "golangci-lint",
  "protoc": {
    "path": "/path/to/protoc",
    "compile_on_save": true,
    "options": [
      "--go_out=.",
      "--go_opt=paths=source_relative",
      "--go-grpc_out=.",
      "--go-grpc_opt=paths=source_relative"
    ]
  }
}
```

### 6.2 GoLand配置

1. **Go Modules**: Settings -> Go -> Go Modules -> 启用 Go Modules
2. **代码格式化**: Settings -> Editor -> Code Style -> Go -> 导入优化
3. **Protobuf支持**: 安装Protobuf插件

---

## 七、数据库初始化

### 7.1 MySQL数据库初始化

```bash
# 连接到MySQL
docker exec -it smartlinkdrive-mysql mysql -uroot -proot

# 创建数据库
CREATE DATABASE IF NOT EXISTS smartlinkdrive CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户表（示例）
USE smartlinkdrive;
CREATE TABLE IF NOT EXISTS users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 7.2 ClickHouse数据库初始化

```bash
# 连接到ClickHouse
docker exec -it smartlinkdrive-clickhouse clickhouse-client

# 创建数据库
CREATE DATABASE IF NOT EXISTS smartlinkdrive;

# 创建轨迹表（示例）
USE smartlinkdrive;
CREATE TABLE IF NOT EXISTS vehicle_trajectory (
    vehicle_id String,
    timestamp DateTime,
    latitude Float64,
    longitude Float64,
    speed Float32,
    direction Float32
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (vehicle_id, timestamp);
```

---

## 八、开发调试

### 8.1 调试gRPC服务

**使用grpcurl:**
```bash
# 列出服务
grpcurl -plaintext localhost:50051 list

# 调用方法
grpcurl -plaintext -d '{"service":"user-service"}' \
    localhost:50051 grpc.health.v1.Health/Check
```

**使用BloomRPC:**
1. 安装BloomRPC: https://github.com/uw-labs/bloomrpc
2. 导入proto文件: `internal/api/proto/health/health.proto`
3. 配置服务地址: `localhost:50051`
4. 调用服务方法

### 8.2 查看日志

```bash
# 查看服务日志
tail -f logs/user-service.log

# 查看Docker服务日志
docker-compose logs -f user-service
```

### 8.3 链路追踪

1. 启动Jaeger UI: http://localhost:16686
2. 在代码中添加span
3. 查看trace信息

---

## 九、常见问题

### 9.1 Docker服务启动失败

**问题**: 端口被占用
**解决**: 
```bash
# 检查端口占用
netstat -ano | findstr :3306  # Windows
lsof -i :3306                  # macOS/Linux

# 修改docker-compose.yml中的端口映射
```

### 9.2 Go模块下载失败

**问题**: 网络问题导致依赖下载失败
**解决**:
```bash
# 设置Go代理
go env -w GOPROXY=https://goproxy.cn,direct

# 或使用阿里云代理
go env -w GOPROXY=https://mirrors.aliyun.com/goproxy/,direct
```

### 9.3 Protobuf生成失败

**问题**: 找不到protoc-gen-go插件
**解决**:
```bash
# 确保插件已安装并在PATH中
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
export PATH=$PATH:$(go env GOPATH)/bin
```

### 9.4 服务注册到Consul失败

**问题**: 无法连接到Consul
**解决**:
```bash
# 检查Consul是否运行
docker ps | grep consul

# 检查Consul端口
curl http://localhost:8500/v1/status/leader
```

---

## 十、开发规范

### 10.1 代码规范

- 遵循Go官方代码规范: https://golang.org/doc/effective_go
- 使用golangci-lint进行代码检查
- 提交前运行 `go fmt` 和 `go vet`

### 10.2 Git工作流

1. 创建功能分支: `git checkout -b feature/xxx`
2. 提交代码: `git commit -m "feat: xxx"`
3. 推送到远程: `git push origin feature/xxx`
4. 创建Pull Request

### 10.3 提交消息格式

使用Conventional Commits格式:
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建/工具相关

---

## 十一、性能优化建议（开发环境）

### 11.1 Docker资源限制

在开发环境中，可以为Docker容器设置资源限制:

```yaml
# docker-compose.yml
services:
  mysql:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
```

### 11.2 Go编译优化

```bash
# 使用race detector（开发环境）
go build -race

# 优化编译（生产环境）
go build -ldflags="-s -w" -trimpath
```

---

## 十二、下一步

完成开发环境搭建后，可以开始:
1. 开发业务服务（参考第二阶段开发计划）
2. 编写单元测试
3. 集成测试
4. API文档生成（Swagger/OpenAPI）

---

*文档版本: v1.0*  
*最后更新: 2024年*