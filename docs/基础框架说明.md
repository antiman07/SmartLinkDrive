# SmartLinkDrive 基础框架说明

## 一、项目结构

```
SmartLinkDrive/
├── cmd/                          # 微服务入口
│   ├── user-service/            # 用户服务
│   └── vehicle-service/         # 车辆服务
├── internal/                     # 内部代码
│   ├── common/                  # 公共组件库
│   │   ├── config/              # 配置管理
│   │   ├── logger/              # 日志组件（支持logrus和zap）
│   │   ├── discovery/           # 服务发现（Consul）
│   │   ├── tracing/             # 链路追踪（Jaeger）
│   │   ├── middleware/          # 中间件（熔断、限流）
│   │   └── db/                  # 数据库连接（MySQL）
│   ├── api/                     # API定义
│   │   └── proto/               # Protobuf定义
│   └── service/                 # 业务服务实现
├── pkg/                          # 可复用公共包
├── deployments/                  # 部署配置
│   ├── docker-compose.yml       # Docker Compose配置
│   └── configs/                 # 服务配置文件
├── configs/                      # 本地配置文件
├── docs/                         # 文档
├── scripts/                      # 脚本
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

## 二、公共组件说明

### 2.1 配置管理 (internal/common/config)

**功能:**
- 支持JSON配置文件
- 支持默认配置（开发环境）
- 单例模式，全局访问
- 支持从 Consul KV 拉取 JSON 配置（最小骨架，便于后续对接配置中心）

**使用示例:**
```go
cfg, err := config.LoadConfig("configs/user-service.json")
if err != nil {
    panic(err)
}

// 获取全局配置
cfg = config.GetConfig()
```

**Consul KV 读取示例（配置中心骨架）:**
```go
cfg, err := config.LoadConfigFromConsulKV("localhost", 8500, "smartlinkdrive/configs/user-service")
if err != nil {
    panic(err)
}
```

### 2.2 日志组件 (internal/common/logger)

**功能:**
- 支持logrus和zap两种实现
- 支持JSON和文本格式
- 支持文件输出和标准输出
- 支持日志级别控制

**使用示例:**
```go
log, err := logger.NewLogger("debug", "text", "stdout", "logs/app.log")
if err != nil {
    panic(err)
}

log.Info("Service started")
log.WithField("service", "user-service").Info("Service info")
```

### 2.3 服务发现 (internal/common/discovery)

**功能:**
- 基于Consul的服务注册与发现
- gRPC服务解析器
- 自动健康检查

**使用示例:**
```go
// 创建Consul客户端
client, err := discovery.NewConsulClient("localhost", 8500)

// 注册服务
registry := discovery.NewServiceRegistry(
    client,
    "user-service-1",
    "user-service",
    "localhost",
    50051,
    []string{"grpc"},
)
registry.Register()
defer registry.Deregister()
```

### 2.4 链路追踪 (internal/common/tracing)

**功能:**
- 基于Jaeger的分布式追踪
- 自动采样配置
- 全局Tracer设置

**使用示例:**
```go
tracer, closer, err := tracing.InitTracer(
    "user-service",
    "localhost:6831",
    1.0,  // 采样率
)
defer closer.Close()
```

### 2.5 中间件 (internal/common/middleware)

**熔断器 (CircuitBreaker):**
```go
cb := middleware.NewCircuitBreaker("user-service", 5, 30*time.Second)

err := cb.Call(ctx, func() error {
    // 执行服务调用
    return client.SomeMethod()
})
```

**限流器 (RateLimiter):**
```go
// 令牌桶限流器
limiter := middleware.NewTokenBucket(100, 10)  // 容量100，每秒10个令牌

if !limiter.Allow(ctx) {
    return errors.New("rate limit exceeded")
}
```

### 2.6 数据库连接 (internal/common/db)

**MySQL连接:**
```go
db, err := db.NewMySQL(
    "localhost", 3306,
    "root", "root", "smartlinkdrive",
    10, 100,  // maxIdle, maxOpen
)

// 使用GORM进行操作
db.Create(&user)
```

## 三、微服务模板

所有微服务都遵循相同的结构：

```go
func main() {
    // 1. 加载配置
    cfg, _ := config.LoadConfig("configs/service.json")
    
    // 2. 初始化日志
    log, _ := logger.NewLogger(...)
    
    // 3. 初始化链路追踪
    tracer, closer, _ := tracing.InitTracer(...)
    defer closer.Close()
    
    // 4. 初始化服务发现
    consulClient, _ := discovery.NewConsulClient(...)
    
    // 5. 启动gRPC服务器
    lis, _ := net.Listen("tcp", ...)
    s := grpc.NewServer()
    
    // 6. 注册服务
    // pb.RegisterXxxServer(s, &service{})
    
    // 7. 注册到Consul
    registry.Register()
    
    // 8. 启动服务器
    go s.Serve(lis)
    
    // 9. 优雅关闭
    // ...
}
```

补充：已提供统一 gRPC 启动模板 `internal/common/server`，负责：
- gRPC server 创建与统一拦截器（recovery / access log / tracing）
- health / reflection 注册
- Consul 注册与注销
- 优雅关闭

## 四、Docker Compose服务说明

### 4.1 数据库服务

- **MySQL**: 端口3306，用于业务数据存储
- **Redis**: 端口6379，用于缓存和会话存储
- **ClickHouse**: 端口8123/9000，用于时序数据存储

### 4.2 基础设施服务

- **Consul**: 端口8500，服务发现和配置中心
- **Kafka**: 端口9092，消息队列
- **Zookeeper**: 端口2181，Kafka依赖

### 4.3 监控和追踪

- **Prometheus**: 端口9090，指标收集
- **Grafana**: 端口3000，可视化面板
- **Jaeger**: 端口16686，链路追踪UI

### 4.4 日志系统

- **Elasticsearch**: 端口9200，日志存储
- **Logstash**: 日志处理
- **Kibana**: 端口5601，日志可视化

## 五、配置文件说明

### 5.1 服务配置文件

服务配置文件位于 `configs/` 或 `deployments/configs/`，包含：

- **server**: 服务名称、地址、端口
- **database**: 数据库连接信息
- **redis**: Redis连接信息
- **consul**: Consul连接信息
- **jaeger**: Jaeger连接信息
- **kafka**: Kafka Broker地址
- **log**: 日志配置

### 5.2 Docker Compose配置

`deployments/docker-compose.yml` 包含所有基础设施服务的配置：

- 服务定义
- 端口映射
- 数据卷挂载
- 环境变量
- 网络配置

## 六、开发流程

### 6.1 创建新服务

1. **创建服务目录:**
```bash
mkdir -p cmd/new-service
mkdir -p internal/service/new
```

2. **复制模板:**
```bash
cp cmd/user-service/main.go cmd/new-service/main.go
```

3. **创建配置文件:**
```bash
cp configs/user-service.json configs/new-service.json
# 修改配置
```

4. **定义Protobuf:**
```bash
# 在 internal/api/proto/ 下创建proto文件
protoc --go_out=. --go-grpc_out=. internal/api/proto/new/*.proto
```

5. **实现服务:**
```go
// 在 internal/service/new/ 实现服务逻辑
```

### 6.2 添加新功能

1. 在相应的服务中实现业务逻辑
2. 添加单元测试
3. 更新API文档
4. 提交代码

## 七、最佳实践

### 7.1 代码规范

- 遵循Go官方代码规范
- 使用golangci-lint进行代码检查
- 提交前运行 `go fmt` 和 `go vet`

### 7.2 错误处理

- 使用 `errors.New()` 或 `fmt.Errorf()` 创建错误
- 包装错误时使用 `fmt.Errorf("%w", err)`
- 日志记录错误时要包含上下文信息

### 7.3 日志记录

- 使用结构化日志
- 包含请求ID、用户ID等上下文信息
- 区分不同日志级别（Debug、Info、Warn、Error）

### 7.4 性能优化

- 使用连接池
- 避免不必要的数据库查询
- 合理使用缓存
- 批量处理操作

## 八、故障排查

### 8.1 服务无法启动

1. 检查配置文件是否正确
2. 检查端口是否被占用
3. 查看日志文件

### 8.2 服务无法注册到Consul

1. 检查Consul是否运行
2. 检查网络连接
3. 检查服务ID是否冲突

### 8.3 数据库连接失败

1. 检查数据库是否运行
2. 检查连接字符串
3. 检查防火墙规则

---

*文档版本: v1.0*
